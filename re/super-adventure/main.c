#include <gb/gb.h>
#include <stdint.h>
#include <string.h>
#include <types.h>
#include "maps/castle_bg.h"
#include "maps/black_bg.h"
#include "maps/entry_map.h"
#include "maps/book.h"
#include "tiles/castle_tiles.h"
#include "tiles/player.h"
#include "tiles/entry_tiles.h"
#include "tiles/book_tiles.h"

// The password used for RC4 encryption/decryption
const unsigned char password[] = "bEDiPbtzXgmL";

// Define the player's starting x and y position
UBYTE PLAYER_X = 5;
UBYTE PLAYER_Y = 0;
BYTE BKG_X = 48;
BYTE BKG_Y = -16;
UBYTE PLAYER_IDX = 5;
UBYTE PLAYER_FACING = 0;
UBYTE PLAYER_CANMOVE = 0;
UBYTE KEYDOWN = 0;

UBYTE CENTER_X = 80;
UBYTE CENTER_Y = 72;

UBYTE WIZARD_CONVO_STATE = 0;

// Code used to check RC4 output
UBYTE code[] = {0,0,0,0,0,0,0,0};

#define MAX_STRING_SIZE 17

const UBYTE dia_first_row_start_adr = 0xd0;
const UBYTE dia_second_row_start_adr =  0xe0;
const UBYTE blk_tile_adr = 0xf0;
const UBYTE arr_tile_adr = 0xf1;
const UBYTE char_offset = 32;

UBYTE dia_wnd_visible = 0;
UBYTE open_dia_lines = 0;

int win_i;

const unsigned char walkable_tiles[] =
{
    1,1,1,1,1,1,1,1,1,1,1,
    1,1,1,0,0,1,0,0,1,1,1,
    1,1,1,1,1,1,1,1,1,1,1,
    1,1,1,1,1,0,1,1,1,1,1,
    1,1,1,0,0,0,0,0,1,1,1,
    1,1,1,1,1,1,1,1,1,1,1,
    1,1,1,1,1,1,1,1,1,1,1,
    1,1,1,0,0,1,0,0,1,1,1,
    1,1,1,1,1,1,1,1,1,0,0,
    1,1,1,1,1,1,1,1,1,0,0,
    1,1,1,1,1,1,1,1,1,0,0,
};

const unsigned char flag[] = {
    0xa8,0x49,0x1d,0x3b,0x18,0x4e,0x85,0xe4,0x59,0x66,0xc0,0x89,0x09,0xb4,0xce,0x1e,
    0x97,0xf2,0x73,0xb5,0x73,0x8f,0x3e,0x65,0xe8,0xee,0x4c,0x58,0x98,0x35,0xc7,0x2a,
    0xb8,0x37,0xe7,0x68,0x71,0x77,0x67,0x44,0x4b,0x7f,0xdd,0x30,0xd1,0x40,0x7a,0x49,
    0x11,0xf0,0xbe,0x37,0xbe,0x8f,0xc3,0x40,0xc3,0xc4,0xfd,0x5a,0x46,0x23,0x6c,0x36,
    0x62,0xfa,0xef,0xdf,0x01,0x37,0x45,0xa1,0xd7,0x82,0x40,0xa4,0x95,0xb9,0xfd,0x8a,
    0xaf,0xda,0xcc,0x27,0x7a,0x17,0xbf,0xa9,0xfd,0xc9,0x05,0x53,0x94,0x05,0x10,0x85,
    0x34,0x45,0x38,0x69,0x10,0xae,0xe6,0xb9,0x3c,0xd9,0xf0,0xa5,0x4e,0xe5,0x5b,0xa2,
    0x5f,0x3c,0xc9,0xa3,0x26,0xd0,0x89,0x92,0x3e,0xba,0xe7,0xa8,0x3e,0xb7,0x59,0x0d,
    0x3e,0x2a,0x74,0x05,0xa4,0x63,0x8d,0xf9,0xf9,0x6a,0x8c,0x58,0xee,0xd2,0xde,0x68,
    0xe0,0x90,0xdc,0x6e,0x6a,0xe9,0x2d,0xa3,0x6f,0x2a,0xae,0xcc,0xe2,0xf4,0x89,0x28,
    0x9a,0x43,0xf2,0xa8,0x5b,0xe7,0xed,0x01,0xdc,0x9c,0x6f,0x70,0x09,0xc2,0x21,0x66,
    0xec,0x69,0x1c,0xbe,0xa2,0xdf,0x6e,0xfa,0xff,0xcf,0xd3,0xdc,0x27,0xd0,0x0d,0x57,
    0x24,0x81,0xf3,0x1f,0xfe,0xd7,0xc6,0x82,0xd2,0x62,0xa2,0x17,0x9f,0x6f,0xe0,0x76,
    0xa4,0x1b,0x7e,0x47,0xd2,0x25,0xb5,0xba,0xb0,0x9b,0x0b,0x59,0x56,0x17,0xca,0xcf,
    0xab,0xdb,0xe9,0x4f,0xb0,0x2c,0x0c,0x3e,0x45,0x68,0x99,0x08,0x97,0x06,0x39,0x98,
    0xdc,0xbd,0xfe,0x35,0xf9,0xa9,0xad,0xc4,0x49,0xf1,0x74,0xec,0x49,0x21,0x2d,0xe7
};

unsigned char decrypted_flag[] = {
    0xa8,0x49,0x1d,0x3b,0x18,0x4e,0x85,0xe4,0x59,0x66,0xc0,0x89,0x09,0xb4,0xce,0x1e,
    0x97,0xf2,0x73,0xb5,0x73,0x8f,0x3e,0x65,0xe8,0xee,0x4c,0x58,0x98,0x35,0xc7,0x2a,
    0xb8,0x37,0xe7,0x68,0x71,0x77,0x67,0x44,0x4b,0x7f,0xdd,0x30,0xd1,0x40,0x7a,0x49,
    0x11,0xf0,0xbe,0x37,0xbe,0x8f,0xc3,0x40,0xc3,0xc4,0xfd,0x5a,0x46,0x23,0x6c,0x36,
    0x62,0xfa,0xef,0xdf,0x01,0x37,0x45,0xa1,0xd7,0x82,0x40,0xa4,0x95,0xb9,0xfd,0x8a,
    0xaf,0xda,0xcc,0x27,0x7a,0x17,0xbf,0xa9,0xfd,0xc9,0x05,0x53,0x94,0x05,0x10,0x85,
    0x34,0x45,0x38,0x69,0x10,0xae,0xe6,0xb9,0x3c,0xd9,0xf0,0xa5,0x4e,0xe5,0x5b,0xa2,
    0x5f,0x3c,0xc9,0xa3,0x26,0xd0,0x89,0x92,0x3e,0xba,0xe7,0xa8,0x3e,0xb7,0x59,0x0d,
    0x3e,0x2a,0x74,0x05,0xa4,0x63,0x8d,0xf9,0xf9,0x6a,0x8c,0x58,0xee,0xd2,0xde,0x68,
    0xe0,0x90,0xdc,0x6e,0x6a,0xe9,0x2d,0xa3,0x6f,0x2a,0xae,0xcc,0xe2,0xf4,0x89,0x28,
    0x9a,0x43,0xf2,0xa8,0x5b,0xe7,0xed,0x01,0xdc,0x9c,0x6f,0x70,0x09,0xc2,0x21,0x66,
    0xec,0x69,0x1c,0xbe,0xa2,0xdf,0x6e,0xfa,0xff,0xcf,0xd3,0xdc,0x27,0xd0,0x0d,0x57,
    0x24,0x81,0xf3,0x1f,0xfe,0xd7,0xc6,0x82,0xd2,0x62,0xa2,0x17,0x9f,0x6f,0xe0,0x76,
    0xa4,0x1b,0x7e,0x47,0xd2,0x25,0xb5,0xba,0xb0,0x9b,0x0b,0x59,0x56,0x17,0xca,0xcf,
    0xab,0xdb,0xe9,0x4f,0xb0,0x2c,0x0c,0x3e,0x45,0x68,0x99,0x08,0x97,0x06,0x39,0x98,
    0xdc,0xbd,0xfe,0x35,0xf9,0xa9,0xad,0xc4,0x49,0xf1,0x74,0xec,0x49,0x21,0x2d,0xe7
};

const UBYTE char_sprites[96][16] =
    {
        // 0 - 31
        {0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF},
        {0xE7, 0xE7, 0xE7, 0xE7, 0xE7, 0xE7, 0xE7, 0xE7, 0xE7, 0xE7, 0xFF, 0xFF, 0xE7, 0xE7, 0xFF, 0xFF},
        {0x99, 0x99, 0x99, 0x99, 0xBB, 0xBB, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF},
        {0xFF, 0xFF, 0xDB, 0xDB, 0x81, 0x81, 0xDB, 0xDB, 0xDB, 0xDB, 0x81, 0x81, 0xDB, 0xDB, 0xFF, 0xFF},
        {0xEB, 0xEB, 0xC1, 0xC1, 0xAA, 0xAA, 0xC3, 0xC3, 0xE1, 0xE1, 0xAA, 0xAA, 0xC1, 0xC1, 0xEB, 0xEB},
        {0x9D, 0x9D, 0x99, 0x99, 0xF3, 0xF3, 0xE7, 0xE7, 0xCF, 0xCF, 0x99, 0x99, 0xB9, 0xB9, 0xFF, 0xFF},
        {0x87, 0x87, 0x33, 0x33, 0x9E, 0x9E, 0x31, 0x31, 0x33, 0x33, 0x33, 0x33, 0x87, 0x87, 0xFF, 0xFF},
        {0xE7, 0xE7, 0xE7, 0xE7, 0xEF, 0xEF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF},
        {0xF7, 0xF7, 0xEF, 0xEF, 0xCF, 0xCF, 0xCF, 0xCF, 0xCF, 0xCF, 0xCF, 0xCF, 0xEF, 0xEF, 0xF7, 0xF7},
        {0xDF, 0xDF, 0xEF, 0xEF, 0xE7, 0xE7, 0xE7, 0xE7, 0xE7, 0xE7, 0xE7, 0xE7, 0xEF, 0xEF, 0xDF, 0xDF},
        {0xFF, 0xFF, 0xAB, 0xAB, 0xC7, 0xC7, 0x01, 0x01, 0xC7, 0xC7, 0xAB, 0xAB, 0xFF, 0xFF, 0xFF, 0xFF},
        {0xFF, 0xFF, 0xE7, 0xE7, 0xE7, 0xE7, 0x81, 0x81, 0xE7, 0xE7, 0xE7, 0xE7, 0xFF, 0xFF, 0xFF, 0xFF},
        {0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xCF, 0xCF, 0xCF, 0xCF, 0xDF, 0xDF},
        {0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xC3, 0xC3, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF},
        {0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xE7, 0xE7, 0xE7, 0xE7, 0xFF, 0xFF},
        {0xFD, 0xFD, 0xF9, 0xF9, 0xF3, 0xF3, 0xE7, 0xE7, 0xCF, 0xCF, 0x9F, 0x9F, 0x3F, 0x3F, 0xFF, 0xFF},
        {0xC3, 0xC3, 0x99, 0x99, 0x91, 0x91, 0x89, 0x89, 0x99, 0x99, 0x99, 0x99, 0xC3, 0xC3, 0xFF, 0xFF},
        {0xE7, 0xE7, 0xC7, 0xC7, 0xE7, 0xE7, 0xE7, 0xE7, 0xE7, 0xE7, 0xE7, 0xE7, 0xE7, 0xE7, 0xFF, 0xFF},
        {0xC3, 0xC3, 0x99, 0x99, 0xF1, 0xF1, 0xE3, 0xE3, 0xC7, 0xC7, 0x8F, 0x8F, 0x81, 0x81, 0xFF, 0xFF},
        {0x81, 0x81, 0xF3, 0xF3, 0xE7, 0xE7, 0xC3, 0xC3, 0xF9, 0xF9, 0xB9, 0xB9, 0xC3, 0xC3, 0xFF, 0xFF},
        {0xF3, 0xF3, 0xE3, 0xE3, 0xD3, 0xD3, 0xB3, 0xB3, 0x81, 0x81, 0xF3, 0xF3, 0xF3, 0xF3, 0xFF, 0xFF},
        {0x81, 0x81, 0x9F, 0x9F, 0x83, 0x83, 0xF9, 0xF9, 0xF9, 0xF9, 0xB9, 0xB9, 0xC3, 0xC3, 0xFF, 0xFF},
        {0xE3, 0xE3, 0xDF, 0xDF, 0x9F, 0x9F, 0x83, 0x83, 0x99, 0x99, 0x99, 0x99, 0xC3, 0xC3, 0xFF, 0xFF},
        {0x81, 0x81, 0xF9, 0xF9, 0xF1, 0xF1, 0xE3, 0xE3, 0xE7, 0xE7, 0xE7, 0xE7, 0xE7, 0xE7, 0xFF, 0xFF},
        {0xC3, 0xC3, 0x99, 0x99, 0x99, 0x99, 0xC3, 0xC3, 0x99, 0x99, 0x99, 0x99, 0xC3, 0xC3, 0xFF, 0xFF},
        {0xC3, 0xC3, 0x99, 0x99, 0x99, 0x99, 0xC1, 0xC1, 0xF9, 0xF9, 0xF3, 0xF3, 0xC7, 0xC7, 0xFF, 0xFF},
        {0xFF, 0xFF, 0xE7, 0xE7, 0xE7, 0xE7, 0xFF, 0xFF, 0xFF, 0xFF, 0xE7, 0xE7, 0xE7, 0xE7, 0xFF, 0xFF},
        {0xFF, 0xFF, 0xE7, 0xE7, 0xE7, 0xE7, 0xFF, 0xFF, 0xE7, 0xE7, 0xE7, 0xE7, 0xEF, 0xEF, 0xFF, 0xFF},
        {0xF9, 0xF9, 0xF3, 0xF3, 0xE7, 0xE7, 0xCF, 0xCF, 0xE7, 0xE7, 0xF3, 0xF3, 0xF9, 0xF9, 0xFF, 0xFF},
        {0xFF, 0xFF, 0xFF, 0xFF, 0xC3, 0xC3, 0xFF, 0xFF, 0xFF, 0xFF, 0xC3, 0xC3, 0xFF, 0xFF, 0xFF, 0xFF},
        {0x9F, 0x9F, 0xCF, 0xCF, 0xE7, 0xE7, 0xF3, 0xF3, 0xE7, 0xE7, 0xCF, 0xCF, 0x9F, 0x9F, 0xFF, 0xFF},
        {0xC3, 0xC3, 0xB9, 0xB9, 0xF9, 0xF9, 0xF3, 0xF3, 0xE7, 0xE7, 0xE7, 0xE7, 0xFF, 0xFF, 0xE7, 0xE7},
        // 32 - 63
        {0xC3, 0xC3, 0x99, 0x99, 0x91, 0x91, 0x95, 0x95, 0x91, 0x91, 0x9F, 0x9F, 0xC3, 0xC3, 0xFF, 0xFF},
        {0xC3, 0xC3, 0x99, 0x99, 0x99, 0x99, 0x81, 0x81, 0x99, 0x99, 0x99, 0x99, 0x99, 0x99, 0xFF, 0xFF},
        {0x83, 0x83, 0x99, 0x99, 0x99, 0x99, 0x83, 0x83, 0x99, 0x99, 0x99, 0x99, 0x83, 0x83, 0xFF, 0xFF},
        {0xC3, 0xC3, 0x9D, 0x9D, 0x9F, 0x9F, 0x9F, 0x9F, 0x9F, 0x9F, 0x9D, 0x9D, 0xC3, 0xC3, 0xFF, 0xFF},
        {0x83, 0x83, 0x99, 0x99, 0x99, 0x99, 0x99, 0x99, 0x99, 0x99, 0x99, 0x99, 0x83, 0x83, 0xFF, 0xFF},
        {0x81, 0x81, 0x9F, 0x9F, 0x9F, 0x9F, 0x83, 0x83, 0x9F, 0x9F, 0x9F, 0x9F, 0x81, 0x81, 0xFF, 0xFF},
        {0x81, 0x81, 0x9F, 0x9F, 0x9F, 0x9F, 0x83, 0x83, 0x9F, 0x9F, 0x9F, 0x9F, 0x9F, 0x9F, 0xFF, 0xFF},
        {0xC3, 0xC3, 0x9D, 0x9D, 0x9F, 0x9F, 0x91, 0x91, 0x99, 0x99, 0x99, 0x99, 0xC1, 0xC1, 0xFF, 0xFF},
        {0x99, 0x99, 0x99, 0x99, 0x99, 0x99, 0x81, 0x81, 0x99, 0x99, 0x99, 0x99, 0x99, 0x99, 0xFF, 0xFF},
        {0xE7, 0xE7, 0xE7, 0xE7, 0xE7, 0xE7, 0xE7, 0xE7, 0xE7, 0xE7, 0xE7, 0xE7, 0xE7, 0xE7, 0xFF, 0xFF},
        {0xF9, 0xF9, 0xF9, 0xF9, 0xF9, 0xF9, 0xF9, 0xF9, 0xF9, 0xF9, 0xB9, 0xB9, 0xC3, 0xC3, 0xFF, 0xFF},
        {0x99, 0x99, 0x93, 0x93, 0x87, 0x87, 0x8F, 0x8F, 0x87, 0x87, 0x93, 0x93, 0x99, 0x99, 0xFF, 0xFF},
        {0x9F, 0x9F, 0x9F, 0x9F, 0x9F, 0x9F, 0x9F, 0x9F, 0x9F, 0x9F, 0x9F, 0x9F, 0x83, 0x83, 0xFF, 0xFF},
        {0x03, 0x03, 0x29, 0x29, 0x29, 0x29, 0x29, 0x29, 0x29, 0x29, 0x39, 0x39, 0x39, 0x39, 0xFF, 0xFF},
        {0x9D, 0x9D, 0x8D, 0x8D, 0x85, 0x85, 0xA1, 0xA1, 0xB1, 0xB1, 0xB9, 0xB9, 0xBD, 0xBD, 0xFF, 0xFF},
        {0xC3, 0xC3, 0x99, 0x99, 0x99, 0x99, 0x99, 0x99, 0x99, 0x99, 0x99, 0x99, 0xC3, 0xC3, 0xFF, 0xFF},
        {0x83, 0x83, 0x99, 0x99, 0x99, 0x99, 0x83, 0x83, 0x9F, 0x9F, 0x9F, 0x9F, 0x9F, 0x9F, 0xFF, 0xFF},
        {0xC3, 0xC3, 0x99, 0x99, 0x99, 0x99, 0x99, 0x99, 0x99, 0x99, 0x99, 0x99, 0xC3, 0xC3, 0xF9, 0xF9},
        {0x83, 0x83, 0x99, 0x99, 0x99, 0x99, 0x83, 0x83, 0x99, 0x99, 0x99, 0x99, 0x99, 0x99, 0xFF, 0xFF},
        {0xC3, 0xC3, 0x9D, 0x9D, 0x8F, 0x8F, 0xC3, 0xC3, 0xF1, 0xF1, 0xB9, 0xB9, 0xC3, 0xC3, 0xFF, 0xFF},
        {0x81, 0x81, 0xE7, 0xE7, 0xE7, 0xE7, 0xE7, 0xE7, 0xE7, 0xE7, 0xE7, 0xE7, 0xE7, 0xE7, 0xFF, 0xFF},
        {0x99, 0x99, 0x99, 0x99, 0x99, 0x99, 0x99, 0x99, 0x99, 0x99, 0x99, 0x99, 0xC3, 0xC3, 0xFF, 0xFF},
        {0x99, 0x99, 0x99, 0x99, 0x99, 0x99, 0x99, 0x99, 0x99, 0x99, 0x9B, 0x9B, 0x87, 0x87, 0xFF, 0xFF},
        {0x39, 0x39, 0x39, 0x39, 0x39, 0x39, 0x29, 0x29, 0x29, 0x29, 0x29, 0x29, 0x03, 0x03, 0xFF, 0xFF},
        {0x99, 0x99, 0x99, 0x99, 0x99, 0x99, 0xC3, 0xC3, 0x99, 0x99, 0x99, 0x99, 0x99, 0x99, 0xFF, 0xFF},
        {0x99, 0x99, 0x99, 0x99, 0x99, 0x99, 0xC3, 0xC3, 0xE7, 0xE7, 0xE7, 0xE7, 0xE7, 0xE7, 0xFF, 0xFF},
        {0x81, 0x81, 0xF1, 0xF1, 0xE3, 0xE3, 0xC7, 0xC7, 0x8F, 0x8F, 0x9F, 0x9F, 0x81, 0x81, 0xFF, 0xFF},
        {0xE1, 0xE1, 0xE7, 0xE7, 0xE7, 0xE7, 0xE7, 0xE7, 0xE7, 0xE7, 0xE7, 0xE7, 0xE1, 0xE1, 0xFF, 0xFF},
        {0xBF, 0xBF, 0x9F, 0x9F, 0xCF, 0xCF, 0xE7, 0xE7, 0xF3, 0xF3, 0xF9, 0xF9, 0xFD, 0xFD, 0xFF, 0xFF},
        {0x87, 0x87, 0xE7, 0xE7, 0xE7, 0xE7, 0xE7, 0xE7, 0xE7, 0xE7, 0xE7, 0xE7, 0x87, 0x87, 0xFF, 0xFF},
        {0xEF, 0xEF, 0xC7, 0xC7, 0x93, 0x93, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF},
        {0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0x81, 0x81, 0xFF, 0xFF},
        // 64 - 95
        {0xFF, 0xFF, 0x3F, 0x3F, 0x3F, 0x3F, 0x9F, 0x9F, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF},
        {0xFF, 0xFF, 0xC3, 0xC3, 0xB9, 0xB9, 0xC1, 0xC1, 0x99, 0x99, 0x99, 0x99, 0xC1, 0xC1, 0xFF, 0xFF},
        {0x9F, 0x9F, 0x83, 0x83, 0x99, 0x99, 0x99, 0x99, 0x99, 0x99, 0x99, 0x99, 0x83, 0x83, 0xFF, 0xFF},
        {0xFF, 0xFF, 0xC3, 0xC3, 0x9D, 0x9D, 0x9F, 0x9F, 0x9F, 0x9F, 0x9D, 0x9D, 0xC3, 0xC3, 0xFF, 0xFF},
        {0xF9, 0xF9, 0xC1, 0xC1, 0x99, 0x99, 0x99, 0x99, 0x99, 0x99, 0x99, 0x99, 0xC1, 0xC1, 0xFF, 0xFF},
        {0xFF, 0xFF, 0xC3, 0xC3, 0x99, 0x99, 0x81, 0x81, 0x9F, 0x9F, 0x9D, 0x9D, 0xC3, 0xC3, 0xFF, 0xFF},
        {0xE1, 0xE1, 0xCF, 0xCF, 0x83, 0x83, 0xCF, 0xCF, 0xCF, 0xCF, 0xCF, 0xCF, 0xCF, 0xCF, 0xFF, 0xFF},
        {0xFF, 0xFF, 0xC1, 0xC1, 0x99, 0x99, 0x99, 0x99, 0x99, 0x99, 0xC1, 0xC1, 0xB9, 0xB9, 0xC3, 0xC3},
        {0x9F, 0x9F, 0x83, 0x83, 0x99, 0x99, 0x99, 0x99, 0x99, 0x99, 0x99, 0x99, 0x99, 0x99, 0xFF, 0xFF},
        {0xE7, 0xE7, 0xFF, 0xFF, 0xE7, 0xE7, 0xE7, 0xE7, 0xE7, 0xE7, 0xE7, 0xE7, 0xE7, 0xE7, 0xFF, 0xFF},
        {0xFF, 0xFF, 0xF7, 0xF7, 0xE7, 0xE7, 0xE7, 0xE7, 0xE7, 0xE7, 0xE7, 0xE7, 0xA7, 0xA7, 0xCF, 0xCF},
        {0x9F, 0x9F, 0x9B, 0x9B, 0x97, 0x97, 0x8F, 0x8F, 0x87, 0x87, 0x93, 0x93, 0x99, 0x99, 0xFF, 0xFF},
        {0xE7, 0xE7, 0xE7, 0xE7, 0xE7, 0xE7, 0xE7, 0xE7, 0xE7, 0xE7, 0xE7, 0xE7, 0xF3, 0xF3, 0xFF, 0xFF},
        {0xFF, 0xFF, 0x03, 0x03, 0x29, 0x29, 0x29, 0x29, 0x29, 0x29, 0x29, 0x29, 0x39, 0x39, 0xFF, 0xFF},
        {0xFF, 0xFF, 0x83, 0x83, 0x99, 0x99, 0x99, 0x99, 0x99, 0x99, 0x99, 0x99, 0x99, 0x99, 0xFF, 0xFF},
        {0xFF, 0xFF, 0xC3, 0xC3, 0x99, 0x99, 0x99, 0x99, 0x99, 0x99, 0x99, 0x99, 0xC3, 0xC3, 0xFF, 0xFF},
        {0xFF, 0xFF, 0x83, 0x83, 0x99, 0x99, 0x99, 0x99, 0x99, 0x99, 0x83, 0x83, 0x9F, 0x9F, 0x9F, 0x9F},
        {0xFF, 0xFF, 0xC1, 0xC1, 0x99, 0x99, 0x99, 0x99, 0x99, 0x99, 0x99, 0x99, 0xC1, 0xC1, 0xF9, 0xF9},
        {0xFF, 0xFF, 0x93, 0x93, 0x8F, 0x8F, 0x9F, 0x9F, 0x9F, 0x9F, 0x9F, 0x9F, 0x9F, 0x9F, 0xFF, 0xFF},
        {0xFF, 0xFF, 0xC3, 0xC3, 0x8D, 0x8D, 0xC7, 0xC7, 0xE3, 0xE3, 0xB1, 0xB1, 0xC3, 0xC3, 0xFF, 0xFF},
        {0xE7, 0xE7, 0xC3, 0xC3, 0xE7, 0xE7, 0xE7, 0xE7, 0xE7, 0xE7, 0xE7, 0xE7, 0xF3, 0xF3, 0xFF, 0xFF},
        {0xFF, 0xFF, 0x99, 0x99, 0x99, 0x99, 0x99, 0x99, 0x99, 0x99, 0x99, 0x99, 0xC1, 0xC1, 0xFF, 0xFF},
        {0xFF, 0xFF, 0x99, 0x99, 0x99, 0x99, 0x99, 0x99, 0x99, 0x99, 0x9B, 0x9B, 0x87, 0x87, 0xFF, 0xFF},
        {0xFF, 0xFF, 0x39, 0x39, 0x39, 0x39, 0x29, 0x29, 0x29, 0x29, 0x29, 0x29, 0x03, 0x03, 0xFF, 0xFF},
        {0xFF, 0xFF, 0x99, 0x99, 0x99, 0x99, 0xC3, 0xC3, 0x99, 0x99, 0x99, 0x99, 0x99, 0x99, 0xFF, 0xFF},
        {0xFF, 0xFF, 0x99, 0x99, 0x99, 0x99, 0x99, 0x99, 0xD9, 0xD9, 0xE1, 0xE1, 0xB9, 0xB9, 0xC3, 0xC3},
        {0xFF, 0xFF, 0x81, 0x81, 0xF1, 0xF1, 0xE3, 0xE3, 0xC7, 0xC7, 0x8F, 0x8F, 0x81, 0x81, 0xFF, 0xFF},
        {0xF1, 0xF1, 0xE7, 0xE7, 0xE7, 0xE7, 0xCF, 0xCF, 0xE7, 0xE7, 0xE7, 0xE7, 0xF1, 0xF1, 0xFF, 0xFF},
        {0xE7, 0xE7, 0xE7, 0xE7, 0xE7, 0xE7, 0xE7, 0xE7, 0xE7, 0xE7, 0xE7, 0xE7, 0xE7, 0xE7, 0xE7, 0xE7},
        {0x8F, 0x8F, 0xE7, 0xE7, 0xE7, 0xE7, 0xF3, 0xF3, 0xE7, 0xE7, 0xE7, 0xE7, 0x8F, 0x8F, 0xFF, 0xFF},
        {0xFF, 0xFF, 0x9F, 0x9F, 0x0D, 0x0D, 0x61, 0x61, 0xF3, 0xF3, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF},
        {0xEF, 0xEF, 0xEF, 0xEF, 0xD7, 0xD7, 0xD7, 0xD7, 0xBB, 0xBB, 0xBB, 0xBB, 0x7D, 0x7D, 0x01, 0x01},
};

/* Definition of a black 8x8 tile */
const unsigned char black_tile[] =
{
  0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,
  0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF
};

/* Definition of an arrow with black background in 8x8 tile */
const unsigned char arrow_tile[] =
{
  0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0x83,0x83,
  0xC7,0xC7,0xEF,0xEF,0xFF,0xFF,0xFF,0xFF
};

unsigned char black_window[] = {
    0xF0,0xF0,0xF0,0xF0,0xF0,0xF0,0xF0,0xF0,0xF0,0xF0,0xF0,0xF0,0xF0,0xF0,0xF0,0xF0,0xF0,0xF0,0xF0,0xF0,
    0xF0,0xF0,0xF0,0xF0,0xF0,0xF0,0xF0,0xF0,0xF0,0xF0,0xF0,0xF0,0xF0,0xF0,0xF0,0xF0,0xF0,0xF0,0xF0,0xF0,
    0xF0,0xF0,0xF0,0xF0,0xF0,0xF0,0xF0,0xF0,0xF0,0xF0,0xF0,0xF0,0xF0,0xF0,0xF0,0xF0,0xF0,0xF0,0xF0,0xF0,
    0xF0,0xF0,0xF0,0xF0,0xF0,0xF0,0xF0,0xF0,0xF0,0xF0,0xF0,0xF0,0xF0,0xF0,0xF0,0xF0,0xF0,0xF0,0xF0,0xF0,
    0xF0,0xF0,0xF0,0xF0,0xF0,0xF0,0xF0,0xF0,0xF0,0xF0,0xF0,0xF0,0xF0,0xF0,0xF0,0xF0,0xF0,0xF0,0xF0,0xF0,
    0xF0,0xF0,0xF0,0xF0,0xF0,0xF0,0xF0,0xF0,0xF0,0xF0,0xF0,0xF0,0xF0,0xF0,0xF0,0xF0,0xF0,0xF0,0xF0,0xF0,
    0xF0,0xF0,0xF0,0xF0,0xF0,0xF0,0xF0,0xF0,0xF0,0xF0,0xF0,0xF0,0xF0,0xF0,0xF0,0xF0,0xF0,0xF0,0xF0,0xF0,
    0xF0,0xF0,0xF0,0xF0,0xF0,0xF0,0xF0,0xF0,0xF0,0xF0,0xF0,0xF0,0xF0,0xF0,0xF0,0xF0,0xF0,0xF0,0xF0,0xF0,
};

unsigned char dia_wnd_tilemap[] =
    {
        0xF0,
        0xF0,
        0xF0,
        0xF0,
        0xF0,
        0xF0,
        0xF0,
        0xF0,
        0xF0,
        0xF0,
        0xF0,
        0xF0,
        0xF0,
        0xF0,
        0xF0,
        0xF0,
        0xF0,
        0xF0,
        0xF0,
        0xD0,
        0xD1,
        0xD2,
        0xD3,
        0xD4,
        0xD5,
        0xD6,
        0xD7,
        0xD8,
        0xD9,
        0xDA,
        0xDB,
        0xDC,
        0xDD,
        0xDE,
        0xDF,
        0xF0,
        0xF0,
        0xF0,
        0xF0,
        0xF0,
        0xF0,
        0xF0,
        0xF0,
        0xF0,
        0xF0,
        0xF0,
        0xF0,
        0xF0,
        0xF0,
        0xF0,
        0xF0,
        0xF0,
        0xF0,
        0xF0,
        0xF0,
        0xE0,
        0xE1,
        0xE2,
        0xE3,
        0xE4,
        0xE5,
        0xE6,
        0xE7,
        0xE8,
        0xE9,
        0xEA,
        0xEB,
        0xEC,
        0xED,
        0xEE,
        0xEF,
        0xF0,
        0xF0,
        0xF0,
        0xF0,
        0xF0,
        0xF0,
        0xF0,
        0xF0,
        0xF0,
        0xF0,
        0xF0,
        0xF0,
        0xF0,
        0xF0,
        0xF0,
        0xF0,
        0xF0,
        0xF0,
        0xF1,
};

const unsigned char opening_dialog[][MAX_STRING_SIZE] = 
{
    "You awake in a  ", 
    "strange tomb in ", 
    "the ancient land",
    "of Cryptonia... "
};

const unsigned char wizard_dialog_1[][MAX_STRING_SIZE] = 
{
    "Have you looked ", 
    "at the book over", 
    "there? I can't  ",
    "seem to decipher",
    "it. The only    ",
    "clue I have is  ",
    "an ancient spell",
    "-book and a word",
    " 'bEDiPbtzXgmL' ",
    "The spell says  ",
    "you must use a  ",
    "'hex'. Whatever ",
    "that means...   "
};

const unsigned char wizard_dialog_2[][MAX_STRING_SIZE] = 
{
    "Did you figure  ", 
    "out what the any",
    "of this means?  ",
    "Remember the    ",
    "word was:       ",
    " 'bEDiPbtzXgmL' ",
    "now for the hex ",
    "....            "
};

const unsigned char wizard_dialog_3[][MAX_STRING_SIZE] = 
{
    "Hmmm... nothing ", 
    "happened... I'm ",
    "not sure we have",
    "the correct hex."
};

const unsigned char wizard_dialog_4[][MAX_STRING_SIZE] = 
{
    "Wow! I felt a   ", 
    "surge of magic! ",
    "Quickly! Check  ",
    "the book!       "
};


void performantdelay(UBYTE numloops){
    for(int i = 0; i < numloops; i++){
        wait_vbl_done();
    }
}

// Wait for the player to press A or B
void wait_for_continue(){
    while (1){
        switch(joypad()){
            case J_A:
                return;
            break;
            case J_B:
                return;
            break;
        }
    }
}

// Gets the first N bytes of the RC4 keystream using the password
void get_rc4_keystream(unsigned char buff[], int N){

    int S[256];
    int temp;
    int j=0;

    // Identity array
    for(int i=0; i<256; i++){
        S[i]=i;
    }

    // Key scheduling
    for(int i=0; i<256; i++){
        j = (j + S[i] + password[i%strlen(password)]) % 256;
        temp = S[i];
        S[i] = S[j];
        S[j] = temp;
    }

    int x = 0;
    int y = 0;
    int t = 0;

    //Get keystream
    for(int i=0; i<N; i++){
        x = (x + 1) % 256;
        y = (y + S[x]) % 256;
        temp = S[x];
        S[x] = S[y];
        S[y] = temp;
        t = (S[x] + S[y]) % 256;
        buff[i] = S[t];
    }
}

void draw_player(int walk_frame){

    switch(walk_frame){
        case 1: // Step 1
            switch(PLAYER_FACING){
                case 1: // Up
                    set_sprite_tile(0,16);
                    set_sprite_tile(1,17);
                    set_sprite_tile(2,18);
                    set_sprite_tile(3,19);
                break;
                case 2: // Left 
                    set_sprite_tile(0,32);
                    set_sprite_tile(1,33);
                    set_sprite_tile(2,34);
                    set_sprite_tile(3,35);
                break;
                case 3: // Right
                    set_sprite_tile(0,24);
                    set_sprite_tile(1,25);
                    set_sprite_tile(2,26);
                    set_sprite_tile(3,27);
                break;
                default: // Down
                    set_sprite_tile(0,4);
                    set_sprite_tile(1,5);
                    set_sprite_tile(2,6);
                    set_sprite_tile(3,7);
                break;
            }
        break;
        case 2: // Step 2
            switch(PLAYER_FACING){
                case 1: // Up
                    set_sprite_tile(0,20);
                    set_sprite_tile(1,21);
                    set_sprite_tile(2,22);
                    set_sprite_tile(3,23);
                break;
                case 2: // Left 
                    set_sprite_tile(0,32);
                    set_sprite_tile(1,33);
                    set_sprite_tile(2,34);
                    set_sprite_tile(3,35);
                break;
                case 3: // Right
                    set_sprite_tile(0,24);
                    set_sprite_tile(1,25);
                    set_sprite_tile(2,26);
                    set_sprite_tile(3,27);
                break;
                default: // Down
                    set_sprite_tile(0,8);
                    set_sprite_tile(1,9);
                    set_sprite_tile(2,10);
                    set_sprite_tile(3,11);
                break;
            }
        break;
        default: // Standing
            switch(PLAYER_FACING){
                case 1: // Up
                    set_sprite_tile(0,12);
                    set_sprite_tile(1,13);
                    set_sprite_tile(2,14);
                    set_sprite_tile(3,15);
                break;
                case 2: // Left 
                    set_sprite_tile(0,36);
                    set_sprite_tile(1,37);
                    set_sprite_tile(2,38);
                    set_sprite_tile(3,39);
                break;
                case 3: // Right
                    set_sprite_tile(0,28);
                    set_sprite_tile(1,29);
                    set_sprite_tile(2,30);
                    set_sprite_tile(3,31);
                break;
                default: // Down
                    set_sprite_tile(0,0);
                    set_sprite_tile(1,1);
                    set_sprite_tile(2,2);
                    set_sprite_tile(3,3);
                break;
            }
        break;
    }

    move_sprite(0,CENTER_X,CENTER_Y);
    move_sprite(1,CENTER_X,CENTER_Y+8);
    move_sprite(2,CENTER_X+8,CENTER_Y);
    move_sprite(3,CENTER_X+8,CENTER_Y+8);
}

void move_player(int dx, int dy){

    // Turn to face
    if (dx == 1){
        PLAYER_FACING = 3;
    } else if (dx == -1) {
        PLAYER_FACING = 2;
    } else if (dy == 1) {
        PLAYER_FACING = 0;
    } else {
        PLAYER_FACING = 1;
    }

    // Can't move outside bounds of room
    if (PLAYER_X+dx < 0 || PLAYER_X+dx > 10 || PLAYER_Y+dy<0 || PLAYER_Y+dy>10) {
        return;
    }

    // Check if tile is walkable
    int idx = (PLAYER_Y+dy)*11+PLAYER_X+dx;

    if (walkable_tiles[idx] == 0){
        return;
    }

    for (int i=0; i<16; i++){
        scroll_bkg(dx,dy);

        BKG_X+=dx;
        BKG_Y+=dy;

        if(i>12){
            draw_player(0);
        } else if (i>8){
            draw_player(2);
        } else if (i>4){
            draw_player(0);
        } else {
            draw_player(1);
        }
        wait_vbl_done();
    }

    PLAYER_X+=dx;
    PLAYER_Y+=dy;
    PLAYER_IDX = PLAYER_Y*11+PLAYER_X;
}

UBYTE show_dia_wnd(unsigned char text_lines[][MAX_STRING_SIZE], UBYTE amount_lin, UBYTE last_lin)
{
    dia_wnd_visible = 1;

    set_win_data(blk_tile_adr, 1, black_tile);
    set_win_data(arr_tile_adr, 1, arrow_tile);

    // Clear Window with black
    for (int ib = 0; ib != 32; ib++)
    {
        set_win_data(dia_first_row_start_adr + ib, 1, black_tile);
    }

    // Write the next two lines
    for (win_i = 0; win_i != 2; win_i++)
    {
        for (int ii = 0; ii < 16; ii++)
        {
            if (win_i == 0)
            {
                set_win_data(dia_first_row_start_adr + ii, 1, char_sprites[text_lines[win_i + last_lin][ii] - char_offset]);
            }
            else
            {
                set_win_data(0xe0 + ii, 1, char_sprites[text_lines[win_i + last_lin][ii] - char_offset]);
            }
        }

        // When amount of lines is even
        if ((win_i + 1) + last_lin == amount_lin)
        {
            return 0;
        }

        // When amount of lines is odd
        if (win_i + last_lin == amount_lin)
        {
            // remove second, black line
            for (int ib = 0; ib != 16; ib++)
            {
                set_win_data(dia_second_row_start_adr + ib, 1, black_tile);
            }
            return 0;
        }
    }

    set_win_tiles(0, 0, 18, 5, dia_wnd_tilemap);
    move_win(15, 96);

    SHOW_WIN;

    return win_i + last_lin;

}

void show_dialog(unsigned char text_lines[][MAX_STRING_SIZE], UBYTE amount_lin){

    // Black out window
    set_win_tiles(0, 0, 20, 8, black_window);

    open_dia_lines = 0;

    // Start dialog and then iterate through lines
    open_dia_lines = show_dia_wnd(text_lines, amount_lin/MAX_STRING_SIZE,open_dia_lines);

    while (1) {

        if(KEYDOWN==1){
            waitpadup();
            KEYDOWN=0;
        }

        switch(joypad()){
        case J_A:
            // Continue text if visible and possible - else close dialog
            if (dia_wnd_visible == 1 & open_dia_lines == 0)
            {
                HIDE_WIN;
                dia_wnd_visible = 0;

                //Leave the key depressed so it doesn't jump into another convo
                KEYDOWN = 1;

                return;
            }
            else
            {
                open_dia_lines = show_dia_wnd(text_lines, amount_lin/MAX_STRING_SIZE, open_dia_lines);
            }

            KEYDOWN = 1;
            break;
        }
    }
}

UBYTE check_answer(){

    unsigned char check_value[4];
    unsigned char key_stream[256];

    // Should be 6B 8A 80 A6
    get_rc4_keystream(check_value,4);

    int check = check_value[0];
    int answer = code[0];

    for(int i=1; i<4; i++){
        check = (check << 8) + check_value[i];
    }

    for(int i=1; i<8; i++){
        answer = (answer << 4) + code[i];
    }

    if (check == answer){

        get_rc4_keystream(key_stream,256);

        for(int i=0; i<256; i++){
            decrypted_flag[i] = flag[i]^key_stream[i];
        }

        return 1;
    }

    return 0;

}

void show_book(){

    UBYTE offset = 46;

    //Load book tiles
    set_win_data(offset,13,book_tiles);

    //Fill in flag tiles that may or may not be decrypted correctly
    set_win_data(offset+13,16,decrypted_flag);

    set_win_tiles(0, 0, 20, 12, book);
    move_win(7,48);

    HIDE_SPRITES;
    SHOW_WIN;

    while(1){

        if(KEYDOWN==1){
            waitpadup();
            KEYDOWN=0;
        }


        // Input from user
        switch(joypad()){
            case J_A:
                KEYDOWN=1;
                HIDE_WIN;
                SHOW_SPRITES;
                return;
            case J_B:
                KEYDOWN=1;
                HIDE_WIN;
                SHOW_SPRITES;
                return;
        }
    }
}

void show_entry(){

    UBYTE cursor = 0;

    UBYTE offset = 46;

    //Load entry tiles
    set_win_data(offset,28,entry_tiles);
    set_win_tiles(0, 0, 20, 12, entry_map);
    move_win(7,48);

    HIDE_SPRITES;

    while(1){

        if(KEYDOWN==1){
            waitpadup();
            KEYDOWN=0;
        }


        // Input from user
        switch(joypad()){
            case J_LEFT:
                KEYDOWN=1;
                if(cursor > 0){
                    cursor--;
                }
                break;
            case J_RIGHT:
                KEYDOWN=1;
                if(cursor<9){
                    cursor++;
                }
                break;
            case J_DOWN:
                KEYDOWN=1;
                if(cursor < 8 && code[cursor]>0){
                    code[cursor]--;
                }
            break;
            case J_UP:
                KEYDOWN=1;
                if(cursor < 8 && code[cursor]<15){
                    code[cursor]++;
                }
            break;
            case J_A:
                KEYDOWN=1;
                if(cursor==8){
                    HIDE_WIN;
                    SHOW_SPRITES;
                    return;
                } else if(cursor==9){

                    // Check if the answer they submitted was correct
                    int result = check_answer();

                    if(result == 1){
                        WIZARD_CONVO_STATE=3;
                    } else {
                        WIZARD_CONVO_STATE=2;
                    }

                    HIDE_WIN;
                    SHOW_SPRITES;
                    return;
                }
                break;
            case J_B:
                KEYDOWN=1;
                HIDE_WIN;
                SHOW_SPRITES;
                return;
        }

        //Draw dynamic parts of entry
        for(int i=0; i<8; i++){
            // If this space of the entry is selected
            if(cursor==i){
                set_win_data(offset+28+i,1,&entry_tiles[16*18]);
                set_win_data(offset+44+i,1,&entry_tiles[16*17]);
            } else {
                set_win_data(offset+28+i,1,black_tile);
                set_win_data(offset+44+i,1,black_tile);
            }
        }

        // Special case for bottom two choices
        if (cursor == 8){
            set_win_data(offset+52,1,&entry_tiles[16*26]);
            set_win_data(offset+53,1,&entry_tiles[16*27]);
            set_win_data(offset+54,1,black_tile);
        } else if (cursor == 9){
            set_win_data(offset+52,1,black_tile);
            set_win_data(offset+53,1,&entry_tiles[16*26]);
            set_win_data(offset+54,1,&entry_tiles[16*27]);
        } else {
            set_win_data(offset+52,1,black_tile);
            set_win_data(offset+53,1,black_tile);
            set_win_data(offset+54,1,black_tile);
        }

        // Fill in numbers
        for(int i=0; i<8; i++){
            set_win_data(offset+36+i,1,&entry_tiles[16*(code[i]+1)]);
        }

        SHOW_WIN;
    }
}

void intro_sequence(){

    // Fade in
    for(int i=0; i<24; i++){
        if(i>=18)
        {
            BGP_REG = 0xE4;
        } else if (i>=12) {
            BGP_REG = 0xF9;
        } else if (i>=6) {
            BGP_REG = 0xFE;
        } else {
            BGP_REG = 0xFF;
        }  
        performantdelay(10);
    }

    show_dialog(opening_dialog, sizeof(opening_dialog));
}

void wizard_convo(){
    switch(WIZARD_CONVO_STATE){
        case 0: // Initial convo
            show_dialog(wizard_dialog_1, sizeof(wizard_dialog_1));
            WIZARD_CONVO_STATE = 1;
            show_entry();
            break;
        case 1: // Followup Convo
            show_dialog(wizard_dialog_2, sizeof(wizard_dialog_2));
            show_entry();
            break;
        case 2: // Answer was incorrect
            show_dialog(wizard_dialog_3, sizeof(wizard_dialog_3));
            WIZARD_CONVO_STATE = 1;
            return;
        default: // Answer was correct! Stay here
            show_dialog(wizard_dialog_4, sizeof(wizard_dialog_4));
            return;
        break;
    }
    // Special case after they submit an answer
    if(WIZARD_CONVO_STATE==2 || WIZARD_CONVO_STATE==3){
        wizard_convo();
    }
}



// Main function
void main() {

    // Load castle tiles into vmem
    set_bkg_data(0,46,castle_tiles);

    // Set background tiles
    set_bkg_tiles(0,0,32,32,castle_bg);

    // Set initial background POS
    scroll_bkg(48,-16);

    //Load player sprite tiles
    set_sprite_data(0,40,player);

    //Draw player facing down in standing position
    draw_player(0);    

    // Turn on graphics and display
    SHOW_SPRITES;
    SHOW_BKG;
    DISPLAY_ON;

    // Fade in and show opening dialog
    intro_sequence();

    // Give player control
    while (1) {

        draw_player(0);

        if(KEYDOWN==1){
            waitpadup();
            KEYDOWN=0;
        }

        switch(joypad()){
            case J_DOWN:
                KEYDOWN = 1;
                move_player(0,1);
            break;
            case J_UP:
                KEYDOWN = 1;
                move_player(0,-1);
            break;
            case J_LEFT:
                KEYDOWN = 1;
                move_player(-1,0);
            break;
            case J_RIGHT:
                KEYDOWN = 1;
                move_player(1,0);
            break;
            case J_A:
                KEYDOWN = 1;
                if((PLAYER_IDX == 118 || PLAYER_IDX == 107 || PLAYER_IDX == 96) && PLAYER_FACING == 3){
                    wizard_convo();
                }
                else if((PLAYER_IDX == 86 || PLAYER_IDX == 87) && PLAYER_FACING == 0){
                    wizard_convo();
                }
                else if((PLAYER_IDX == 27 && PLAYER_FACING == 0) || (PLAYER_IDX == 60 && PLAYER_FACING == 1)){
                    show_book();
                }
        }
    }
}